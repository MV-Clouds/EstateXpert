<template>
    <template if:true={isAccessible}>
        <div class="wrapper">
            <div class="main_header_cls">
                <div class="sub_main_header_css">
                    <div slot="title" class="header_block_css">
                        Marketing Campaign
                    </div>
                    <div class="header">
                        <button class="btn" onclick={handleAdd}>
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14 8H8V14H6V8H0V6H6V0H8V6H14V8Z" fill="white"/>
                            </svg> 
                            Add New                       
                        </button>
                    </div>
                </div>
            </div>

        <div class="main_content_cls">
            <div class="slds-m-around_medium navbar">
                <div class="search-input">
                    <lightning-input type="search" onchange={handleSearch} placeholder="Search Campaign" class="input-campaign" variant="label-hidden"></lightning-input>
                </div>
                <div class="filter-btn-container">
                    <button class="edit-btn" onclick={refreshTable}>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000">
                            <path d="M21 3V8M21 8H16M21 8L18 5.29168C16.4077 3.86656 14.3051 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.2832 21 19.8675 18.008 20.777 14"
                                stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </button>
                    <button class="filter-btn" onclick={handleFilterClick}>
                        <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15 2.40009C15 1.91004 14.9997 1.66483 14.9043 1.47766C14.8204 1.31302 14.6871 1.17926 14.5224 1.09537C14.3352 1 14.0897 1 13.5997 1H2.39966C1.90961 1 1.66483 1 1.47766 1.09537C1.31302 1.17926 1.17926 1.31302 1.09537 1.47766C1 1.66483 1 1.91004 1 2.40009V3.04519C1 3.2592 1 3.36629 1.02418 3.46699C1.04561 3.55628 1.08105 3.64156 1.12903 3.71985C1.18312 3.80812 1.25892 3.88392 1.41016 4.03516L5.84005 8.46506C5.99138 8.61638 6.06663 8.69163 6.12074 8.77993C6.16872 8.85822 6.20464 8.9438 6.22607 9.03308C6.25 9.13276 6.25 9.23858 6.25 9.44826V13.6096C6.25 14.3597 6.25 14.735 6.40798 14.9608C6.54592 15.1581 6.75873 15.2896 6.99683 15.3248C7.2695 15.3651 7.60512 15.1975 8.276 14.8621L8.976 14.5121C9.25693 14.3716 9.39705 14.3011 9.49968 14.1964C9.59043 14.1037 9.65986 13.9924 9.70215 13.8698C9.74997 13.7312 9.75 13.5737 9.75 13.2596V9.45477C9.75 9.24076 9.75 9.13378 9.77418 9.03308C9.79561 8.9438 9.83105 8.85822 9.87903 8.77993C9.93278 8.69222 10.0078 8.61717 10.1572 8.46785L10.1602 8.46506L14.5901 4.03516C14.7414 3.88382 14.8166 3.80815 14.8707 3.71985C14.9187 3.64156 14.9546 3.55628 14.9761 3.46699C15 3.36732 15 3.26138 15 3.0517V2.40009Z" stroke="#0176D3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Filter                            
                    </button>
                </div>
            </div>
            
            <template if:true={visibleCampaigns.length}>
                <div class="table-content">
                    <table class="slds-table">
                        <thead>
                            <tr class="table_tr_cls">
                                <th scope="col" class="sno">
                                    <div>No.</div>
                                </th>
                                <th scope="col" class="marketing-campaign-name">
                                    <div>Marketing Campaign Name</div>
                                </th>
                                <th scope="col" class="marketing-camapign-template">
                                    <div>Campaign Template</div>
                                </th>
                                <th scope="col" class="status">
                                    <div class="status_cls">Status</div>
                                </th>
                                <th scope="col" class="total-emails">
                                    <div>Total Emails</div>
                                </th>
                                <th scope="col" class="remaining-emails">
                                    <div>Remaining Emails</div>
                                </th>
                                <th scope="col" class="remaining-emails">
                                    <div>Failed Emails</div>
                                </th>
                                <th scope="col" class="progress">
                                    <div class="progress_cls">Progress</div>
                                </th>
                                <th scope="col" class="start-date">
                                    <div>Start Date</div>
                                </th>
                                <th scope="col" class="created-date">
                                    <div>Created Date</div>
                                </th>
                                <th scope="col" class="actions">
                                    <div class="action_cls">Action</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template for:each={visibleCampaigns} for:item="campaign" for:index="index">
                                <tr key={campaign.Id}>
                                    <td data-label="S.No.">
                                        <div>{campaign.rowIndex}</div>
                                    </td>
                                    <td data-label="Campaign Name" class="truncate_css">
                                        <div class="clickable_css" onclick={openMemberModal} data-id={campaign.Id}>{campaign.MVEX__Label__c}</div>
                                    </td>
                                    <td data-label="Campaign Template">
                                        <div>{campaign.IsCampaignTemplate}</div>
                                    </td>
                                    <td data-label="Status">
                                        <div class={campaign.statusClass}>{campaign.MVEX__Status__c}</div>
                                    </td>
                                    <td data-label="total emails">
                                        <div>{campaign.MVEX__Total_Emails__c}</div>
                                    </td>
                                    <td data-label="total emails">
                                        <div>{campaign.MVEX__Remaining_Emails__c}</div>
                                    </td>
                                    <td data-label="total emails">
                                        <div>{campaign.MVEX__Failed_Emails__c}</div>
                                    </td>
                                    <td data-label="Progress bar" class="progress-container">
                                        <lightning-progress-bar value={campaign.progressPercentage} size="large" variant="circular"></lightning-progress-bar>
                                    </td>
                                    <td data-label="Start Date">
                                        <div>{campaign.StartDateformatted}</div>
                                    </td>
                                    <td data-label="Created Date">
                                        <div>{campaign.CreatedDateformatted}</div>
                                    </td>
                                    <td data-label="Actions">
                                        <div class="action-btn">
                                            <button onclick={openMemberModal} data-id={campaign.Id} class="action-div">
                                                <lightning-icon width="14" height="14" icon-name='utility:preview'  alternative-text="preview"
                                                    size="xx-small"></lightning-icon>
                                            </button>
                                            <button class="action-div" onclick={handleEdit} data-id={campaign.Id} disabled={campaign.canEdit}>
                                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M13.0416 13.0417H8.45831M0.958313 13.0417L4.49998 12.2083L12.2441 4.46426C12.5695 4.13882 12.5695 3.61119 12.2441 3.28575L10.7142 1.75593C10.3888 1.43049 9.86115 1.43049 9.53573 1.75593L1.79165 9.50001L0.958313 13.0417Z" stroke="#212529" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>                                                    
                                            </button>
                                            <button class="delete-div" onclick={handleDelete} data-id={campaign.Id} disabled={campaign.canDelete}>
                                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M2.62502 3.45834L3.32598 11.5194C3.40087 12.3807 4.12187 13.0417 4.98638 13.0417H9.01369C9.87819 13.0417 10.5992 12.3807 10.674 11.5194L11.375 3.45834M5.12502 3.25V2.625C5.12502 1.70453 5.87119 0.958336 6.79169 0.958336H7.20835C8.12885 0.958336 8.87502 1.70453 8.87502 2.625V3.25M1.16669 3.45834H12.8334" stroke="#212529" stroke-width="1.25" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pagination-container">
                    <button class="pagination-button" disabled={isFirstPage} onclick={handlePrevious}>
                        <svg xmlns="http://www.w3.org/2000/svg" height="52" width="52" viewBox="0 0 520 520" fill="#fff">
                            <path d="M342 477 134 272c-6-6-6-16 0-22L342 45c6-6 16-6 22 0l22 22c6 6 6 16 0 22L221 250c-6 6-6 16 0 22l163 161c6 6 6 16 0 22l-22 22c-5 5-14 5-20 0z"/>
                        </svg> 
                        Previous
                    </button>
                    
                    <template for:each={pageNumbers} for:item="page">
                        <template if:false={page.isEllipsis}>
                            <button key={page.number} data-id={page.number} class={page.className} onclick={handlePageChange}>
                                {page.number}
                            </button>
                        </template>
                        <template if:true={page.isEllipsis}>
                            <span key={page.number} class="pagination-ellipsis">...</span>
                        </template>
                    </template>
                    
                    <button class="pagination-button" disabled={isLastPage} onclick={handleNext}>
                        Next 
                        <svg xmlns="http://www.w3.org/2000/svg" height="52" width="52" viewBox="0 0 520 520" fill="#fff">
                            <path d="m179 44 207 205c6 6 6 16 0 22L179 476c-6 6-16 6-22 0l-22-22c-6-6-6-16 0-22l163-161c6-6 6-16 0-22L136 88c-6-6-6-16 0-22l22-22c6-5 15-5 21 0z"/>
                        </svg>
                    </button>
                </div>
            </template>
            <template if:false={visibleCampaigns.length}>
                <div class="no-data-container">
                    <div class="no-data-message">
                        No Campaign Found
                    </div>
                </div>
            </template>
        </div>  
    </div>
    </template>

    <template if:false={isAccessible}>
        <div class="slds-grid slds-wrap slds-align_absolute-center full-page-container">
            <div class="restricted-access">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"
                        fill="currentColor" />
                </svg>
                <h1>Access Restricted</h1>
                <p>You don't have permission to access this page. Please contact your administrator for further
                    assistance.</p>
            </div>
        </div>
    </template>

    <!-- <c-email-campaign-modal if:true={isModalOpen} onclose={handleModalClose}> </c-email-campaign-modal> -->

    <c-send-emails if:true={isModalOpen} onclose={handleModalClose} show-modal={isModalOpen} object-api-name={objectName}
        selected-contacts={selectedContactList}>
    </c-send-emails>


    <template if:true={isFilterModalOpen}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open slds-modal_small">
            <div class="slds-modal__container">
                <!-- Modal/Popup Header -->
                <div class="slds-modal__close closs_icon_css" onclick={closeFilterModal}>
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path
                        d="M2.53317 19.3333L0.666504 17.4667L8.13317 9.99999L0.666504 2.53332L2.53317 0.666656L9.99984 8.13332L17.4665 0.666656L19.3332 2.53332L11.8665 9.99999L19.3332 17.4667L17.4665 19.3333L9.99984 11.8667L2.53317 19.3333Z"
                        fill="white" />
                    </svg>
                </div>
                
                <div class="slds-modal__header blue-header">
                    <h1 class="slds-modal__title slds-hyphenate" tabindex="-1">Filter Campaigns</h1>
                </div>
                <!-- Modal/Popup Body -->
                <div class="slds-modal__content slds-p-around_medium filter-body">
                    <lightning-combobox label="Status" placeholder="Select a status" options={statusOptions} onchange={handleFilterChange} data-id="statusFilter" value={statusFilter}></lightning-combobox>

                    <div class="slds-p-top_small">
                        <template for:each={statusFilterList} for:item="status">
                            <lightning-pill 
                            key = {status}
                            label = {status}
                            name = {status}
                            onremove = {handleRemove}>
                            <lightning-icon icon-name="standard:account" alternative-text="Account"></lightning-icon>
                        </lightning-pill>
                        </template>
                    </div>
                    <div class="filter-dates">
                        <div class="filter-created-date">
                            <lightning-input type="date" label="Created Date Start" onchange={handleFilterChange} value={createdDateStart} data-id="createdDateStart"></lightning-input>
                        </div>
                        <div class="filter-end-date">
                            <lightning-input type="date" label="Created Date End" onchange={handleFilterChange} value={createdDateEnd} data-id="createdDateEnd"></lightning-input>
                        </div>
                    </div>
                    <div class="filter-modal-footer">
                        <button class="cancel_btn_css" onclick={clearFilterModal}>Cancel</button>
                        <button class="save_btn_css" onclick={applyFilter}>Apply Filter</button>
                    </div>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <template if:true={isLoading}>
        <c-spinner-component></c-spinner-component>
    </template>

    <c-message-popup onconfirmation={handleConfirmation}></c-message-popup>
</template>