<!--
  description       : Display inquiry component to display all the properties
  author            : Rachit Shah
  last modified on  : 06-19-2024
-->
<template>

    <template if:true={isLoading}>
        <c-spinner-component></c-spinner-component>
    </template>

    <div class="main-card">

        <div class="filter-search-container">
            <div class="filter-section">
                <div class="search-bar">
                    <lightning-input variant="label-hidden" type="search" placeholder="Search Inquiry Name"
                        value={searchTerm} onchange={handleSearch} class="search-bar-input"></lightning-input>
                </div>

                <div class="open-mapping-div" onclick={handleInsideClick}>

                    <div class="btn-container">

                        <button class="btn mapping-btn" onclick={openConfigureSettings}><svg fill="white" height="18px" width="18px" version="1.1" viewBox="0 0 512.003 512.003">
                                <g>
                                    <path d="M491.584,192.579l-55.918-6.914c-0.919-2.351-1.884-4.682-2.892-6.993l34.648-44.428
                                        c7.227-9.267,6.412-22.464-1.899-30.773l-57.028-56.996c-8.308-8.304-21.502-9.114-30.763-1.893L333.32,79.216
                                        c-2.312-1.008-4.644-1.974-6.994-2.894l-6.915-55.904c-1.443-11.66-11.348-20.415-23.097-20.415h-80.637
                                        c-11.748,0-21.656,8.755-23.097,20.416l-6.914,55.904c-2.349,0.919-4.681,1.884-6.988,2.89l-44.415-34.642
                                        c-9.261-7.222-22.458-6.414-30.768,1.894l-57.021,57.009c-8.31,8.307-9.123,21.506-1.896,30.771l34.644,44.417
                                        c-1.012,2.312-1.978,4.647-2.9,7.002l-55.906,6.914C8.757,194.022,0,203.927,0,215.676v80.64c0,11.75,8.758,21.658,20.421,23.097
                                        l55.901,6.903c0.919,2.352,1.884,4.686,2.894,6.994l-34.641,44.417c-7.224,9.264-6.411,22.46,1.894,30.767l57.021,57.031
                                        c8.307,8.31,21.507,9.121,30.773,1.896l44.417-34.648c2.306,1.007,4.638,1.974,6.987,2.891l6.914,55.921
                                        c1.441,11.66,11.348,20.416,23.097,20.416h80.637c11.748,0,21.655-8.755,23.097-20.416l6.915-55.92
                                        c2.351-0.92,4.682-1.885,6.993-2.892l44.425,34.65c9.266,7.225,22.463,6.414,30.771-1.898l57.015-57.031
                                        c8.307-8.308,9.117-21.504,1.893-30.768l-34.641-44.409c1.012-2.313,1.978-4.647,2.898-7.002l55.901-6.903
                                        c11.661-1.44,20.421-11.348,20.421-23.097v-80.64C512,203.927,503.243,194.022,491.584,192.579z M465.455,275.74l-49.864,6.158
                                        c-9.151,1.131-16.772,7.556-19.431,16.386c-2.813,9.337-6.56,18.387-11.138,26.903c-4.367,8.124-3.525,18.063,2.147,25.335
                                        l30.898,39.613l-27.924,27.932l-39.621-30.905c-7.269-5.668-17.202-6.513-25.327-2.15c-8.513,4.572-17.565,8.319-26.905,11.134
                                        c-8.827,2.661-15.25,10.279-16.381,19.427l-6.169,49.883h-39.492l-6.167-49.883c-1.131-9.146-7.551-16.763-16.375-19.425
                                        c-9.367-2.825-18.417-6.571-26.899-11.132c-8.122-4.369-18.061-3.527-25.336,2.147l-39.615,30.902L93.929,390.13l30.897-39.618
                                        c5.671-7.273,6.513-17.206,2.147-25.328c-4.568-8.501-8.315-17.554-11.137-26.911c-2.662-8.825-10.282-15.247-19.430-16.376
                                        l-49.861-6.156v-39.492l49.866-6.167c9.146-1.131,16.763-7.551,19.423-16.375c2.824-9.356,6.572-18.406,11.143-26.9
                                        c4.374-8.124,3.533-18.067-2.143-25.342l-30.903-39.62l27.924-27.918l39.62,30.902c7.273,5.672,17.209,6.513,25.335,2.146
                                        c8.493-4.565,17.541-8.31,26.896-11.132c8.825-2.662,15.247-10.279,16.378-19.427l6.166-49.867h39.494l6.169,49.869
                                        c1.133,9.148,7.557,16.767,16.384,19.427c9.328,2.811,18.379,6.557,26.902,11.135c8.122,4.364,18.055,3.522,25.325-2.149
                                        l39.616-30.894l27.927,27.912l-30.897,39.618c-5.666,7.267-6.513,17.191-2.158,25.311c4.58,8.54,8.328,17.599,11.138,26.923
                                        c2.661,8.825,10.279,15.248,19.427,16.381l49.878,6.169V275.74z"/>
                                    <path d="M255.997,155.153c-55.606,0-100.845,45.244-100.845,100.856c0,55.603,45.239,100.839,100.845,100.839
                                        c55.609,0,100.852-45.236,100.852-100.839C356.849,200.397,311.606,155.153,255.997,155.153z M255.997,310.303
                                        c-29.941,0-54.3-24.356-54.3-54.294c0-29.947,24.359-54.311,54.3-54.311c29.944,0,54.306,24.363,54.306,54.311
                                        C310.303,285.947,285.941,310.303,255.997,310.303z"/>
                                </g>
                            </svg>Settings
                        </button>
                        <template if:true={isConfigOpen}>
                            <c-record-config-body-cmp feature-name="Inquiry Manager"
                                onclose={handleCloseModal}></c-record-config-body-cmp>
                        </template>

                        <template if:true={hasBusinessAccountConfigured}>
                            <button class="btn mapping-btn" onclick={handleSendMessage}
                                disabled={isSendEmailButtonDisabled}>
                                <svg width="18px" height="18px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" 
                                        d="M3.50002 12C3.50002 7.30558 7.3056 3.5 12 3.5C16.6944 3.5 20.5 7.30558 20.5 12C20.5 16.6944 16.6944 20.5 12 20.5C10.3278 20.5 8.77127 20.0182 7.45798 19.1861C7.21357 19.0313 6.91408 18.9899 6.63684 19.0726L3.75769 19.9319L4.84173 17.3953C4.96986 17.0955 4.94379 16.7521 4.77187 16.4751C3.9657 15.176 3.50002 13.6439 3.50002 12ZM12 1.5C6.20103 1.5 1.50002 6.20101 1.50002 12C1.50002 13.8381 1.97316 15.5683 2.80465 17.0727L1.08047 21.107C0.928048 21.4637 0.99561 21.8763 1.25382 22.1657C1.51203 22.4552 1.91432 22.5692 2.28599 22.4582L6.78541 21.1155C8.32245 21.9965 10.1037 22.5 12 22.5C17.799 22.5 22.5 17.799 22.5 12C22.5 6.20101 17.799 1.5 12 1.5ZM14.2925 14.1824L12.9783 15.1081C12.3628 14.7575 11.6823 14.2681 10.9997 13.5855C10.2901 12.8759 9.76402 12.1433 9.37612 11.4713L10.2113 10.7624C10.5697 10.4582 10.6678 9.94533 10.447 9.53028L9.38284 7.53028C9.23954 7.26097 8.98116 7.0718 8.68115 7.01654C8.38113 6.96129 8.07231 7.046 7.84247 7.24659L7.52696 7.52195C6.76823 8.18414 6.3195 9.2723 6.69141 10.3741C7.07698 11.5163 7.89983 13.314 9.58552 14.9997C11.3991 16.8133 13.2413 17.5275 14.3186 17.8049C15.1866 18.0283 16.008 17.7288 16.5868 17.2572L17.1783 16.7752C17.4313 16.5691 17.5678 16.2524 17.544 15.9269C17.5201 15.6014 17.3389 15.308 17.0585 15.1409L15.3802 14.1409C15.0412 13.939 14.6152 13.9552 14.2925 14.1824Z" 
                                        fill="white"/>
                                </svg>
                                Send Message
                            </button>
                        </template>

                        <button class="btn mapping-btn" onclick={openModal} disabled={isSendEmailButtonDisabled}> 
                            <svg width="18px" height="18px" version="1.1" viewBox="0 0 512 512">
                                <g>
                                    <path d="M2.072,127.79c-1.335,4.946-2.058,10.14-2.058,15.502c0,241.727-0.087,226.177,0.18,229.813L157.121,229.27L2.072,127.79z" fill="white"/>
                                    <path d="M255.904,281.128c-23.968,0-35.227-10.26-66.592-30.789L15.964,409.225c10.888,11.717,26.415,19.066,43.633,19.066h392.611c17.219,0,32.746-7.35,43.633-19.066L322.495,250.34C291.131,270.868,279.87,281.128,255.904,281.128z" fill="white"/>
                                    <path d="M271.397,239.225l217.829-142.57c-10.174-8.093-23.036-12.946-37.017-12.946H59.597c-13.981,0-26.842,4.853-37.018,12.946l217.829,142.57C249.821,245.385,261.986,245.386,271.397,239.225z" fill="white"/>
                                    <path d="M509.734,127.79l-155.05,101.48l156.928,143.835C511.704,371.862,513.168,140.518,509.734,127.79z" fill="white"/>
                                </g>
                            </svg>
                            Send Mail
                        </button>

                        <template if:true={hideFilterButton}>
                            <button class="btn mapping-btn" onclick={showModalBox}>
                                <svg width="18px" height="18px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" >
                                    <path fill-rule="evenodd" clip-rule="evenodd" 
                                        d="M3 7C3 6.44772 3.44772 6 4 6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H4C3.44772 8 3 7.55228 3 7ZM6 12C6 11.4477 6.44772 11 7 11H17C17.5523 11 18 11.4477 18 12C18 12.5523 17.5523 13 17 13H7C6.44772 13 6 12.5523 6 12ZM9 17C9 16.4477 9.44772 16 10 16H14C14.5523 16 15 16.4477 15 17C15 17.5523 14.5523 18 14 18H10C9.44772 18 9 17.5523 9 17Z" 
                                        fill="white"/>
                                </svg>Filters
                            </button>
                        </template>
                    </div>

                    <template if:true={isShowModal}>
                        <div class="filter-div">
                            <div class="filter-fields">
                                <div class="filter-header">
                                    Filter Inquiries
                                </div>
                                <div class="scroll-div">
                                    <div class="slds-form_element">
                                        <lightning-combobox name="conditionType" label="Condition Type"
                                            value={selectedConditionType} options={conditionOptions}
                                            onchange={handleConditionTypeChange}>
                                        </lightning-combobox>
                                    </div>

                                    <template if:true={isCustomLogicSelected}>
                                        <div class="slds-form_element slds-m-top_medium">
                                            <label><span class="required-class">*</span>Logical Expression</label>
                                            <lightning-input variant="label-hidden" data-id="condition-input"
                                                value={logicalExpression} onchange={handleLogicalExpressionChange}
                                                placeholder="Enter logical expression">
                                            </lightning-input>
                                        </div>
                                    </template>

                                    <div class="slds-m-top_medium">
                                        <template if:false={mappings.length}>
                                            <p class="slds-text-align_center slds-text-color_weak slds-p-around_medium">
                                                No filters applied for this object.</p>
                                        </template>

                                        <template for:each={mappings} for:item="mapping">


                                            <div key={mapping.id} class="parent-div">
                                                <div class={mappingClass} onclick={handleMappingClick}
                                                    data-id={mapping.id} data-name="mapping-box">
                                                    <span class="mapping-id">{mapping.id}</span>

                                                    <div class="mapping-data">
                                                        {mapping.label} <br>
                                                        {mapping.displayOperator} " {mapping.valueField} "
                                                    </div>
                                                    <div class="delete-div" title="Delete" data-id={mapping.id}
                                                        onclick={handleDeleteMapping} data-name="delete">
                                                        <!-- <lightning-icon icon-name="utility:delete"  data-id={mapping.id} alternative-text="delete" size="small"></lightning-icon> -->
                                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                                            xmlns="http://www.w3.org/2000/svg" data-id={mapping.id}>
                                                            <path d="M3 6H5H21" stroke="#A30D11" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round" />
                                                            <path
                                                                d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z"
                                                                stroke="#A30D11" stroke-width="2" stroke-linecap="round"
                                                                stroke-linejoin="round" />
                                                            <path d="M10 11V17" stroke="#A30D11" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round" />
                                                            <path d="M14 11V17" stroke="#A30D11" stroke-width="2"
                                                                stroke-linecap="round" stroke-linejoin="round" />
                                                        </svg>

                                                        <span class="slds-assistive-text">Delete</span>
                                                    </div>
                                                </div>

                                            </div>
                                        </template>
                                    </div>
                                </div>

                            </div>
                            <div class="filter-footer">
                                <div class="add-condtion">
                                    <button class="btn modal-btn-blue" onclick={addCondition}
                                        disabled={isRealatedList}>Add Condition</button>
                                    <template if:true={isAddConditionModalVisible}>
                                        <div class="condition-div">
                                            <div class="filter-header">
                                                Configure Condition
                                            </div>
                                            <div class="condition-div-body">
                                                <div class="slds-form_element">
                                                    <lightning-combobox name="inquiryField" label="Inquiry Field"
                                                        value={inquiryFieldObject.MVEX__Field_Name__c}
                                                        options={inquirypicklistoptions}
                                                        onchange={handleInquiryFieldChange} required>
                                                    </lightning-combobox>
                                                </div>

                                                <div class="slds-form_element slds-m-top_medium">
                                                    <lightning-combobox name="conditionOperator" label="Condition"
                                                        value={selectedConditionOperator}
                                                        options={conditionOperatorOptions}
                                                        onchange={handleConditionOperatorChange} required>
                                                    </lightning-combobox>
                                                </div>

                                                <div class="slds-form_element slds-m-top_medium">
                                                    <lightning-input type="checkbox" label="Use Constant Value"
                                                        checked={isConstant} onchange={handleUseConstantChange}>
                                                    </lightning-input>
                                                </div>

                                                <template if:true={isConstant}>
                                                    <div class="slds-form_element slds-m-top_medium">
                                                        <label><span class="red">*</span>Value</label>
                                                        <template if:true={inquiryFieldObject.isPrimary}>
                                                            <lightning-input
                                                                type={inquiryFieldObject.MVEX__Data_Type__c}
                                                                value={selectedListingField} data-field="MVEX__Value__c"
                                                                onchange={handleListingFieldChange}
                                                                variant="label-hidden"></lightning-input>
                                                        </template>
                                                        <template if:true={inquiryFieldObject.isPicklist}>
                                                            <lightning-combobox value={selectedListingField}
                                                                data-field="MVEX__Value__c"
                                                                options={inquiryFieldObject.picklistValues}
                                                                onchange={handleListingFieldChange}
                                                                variant="label-hidden"></lightning-combobox>
                                                        </template>
                                                        <template if:true={inquiryFieldObject.isReference}>
                                                            <lightning-record-picker value={selectedListingField}
                                                                label="Reference" data-field="MVEX__Value__c"
                                                                object-api-name={inquiryFieldObject.objectApiName}
                                                                onchange={handleRefChange}
                                                                variant="label-hidden"></lightning-record-picker>
                                                        </template>
                                                    </div>
                                                </template>

                                                <template if:false={isConstant}>
                                                    <div class="slds-form_element slds-m-top_medium">
                                                        <lightning-combobox name="listingField" label="Listing Field"
                                                            value={selectedListingField} options={listingFieldOptions}
                                                            onchange={handleListingFieldChange} required>
                                                        </lightning-combobox>
                                                    </div>
                                                </template>
                                            </div>
                                            <div class="condition-div-footer">
                                                <button class="btn modal-btn-white"
                                                    onclick={closeAddConditionModal}>Cancel</button>
                                                <button class="btn modal-btn-blue" onclick={saveCondition}>Save</button>
                                            </div>
                                            <div class="arrow"></div>
                                        </div>
                                    </template>
                                </div>
                                <div class="custom__footer">
                                    <button class="btn modal-btn-white" onclick={hideModalBox}>Cancel</button>
                                    <button class="btn modal-btn-blue" onclick={applyModalFilters}>Apply</button>
                                </div>
                            </div>
                        </div>

                    </template>
                </div>
            </div>
        </div>

        <div class="slds-col slds-theme_default data-table-container">
            <template if:true={pagedInquries.length}>
                <table class="custom-data-table">
                    <thead>
                        <tr>
                            <th class="header-cell slds-text-align_right slds-cell_action-mode colume1" scope="col">
                                <span id="column-group-header" class="slds-assistive-text">Choose a row</span>
                                <div class="header-checkbox-div">
                                    <label class="custom-checkbox">
                                        <input type="checkbox" onchange={selectAllCheckbox} checked={checkAll}>
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                            </th>
                            <th class="header-cell slds-truncate">Inquiry Name</th>
                            <template for:each={tableColumns} for:item="column">
                                <th key={column.fieldName} class="header-cell slds-truncate">{column.label}</th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template for:each={pagedInquries} for:item="inquiry">
                            <tr key={inquiry.id}>
                                <td class="slds-text-align_right slds-cell_action-mode checkbox-cell" role="gridcell">
                                    <label class="custom-checkbox custom-checkbox-body">
                                        <input data-id={inquiry.id} type="checkbox" checked={inquiry.isSelected}
                                            value={inquiry.isSelected} onchange={checkBoxValueChange}>
                                        <span class="checkmark"></span>
                                    </label>
                                </td>
                                <td class="slds-truncate">
                                    <a href="javascript:void(0)" data-id={inquiry.id}
                                        onclick={navigateToRecord}>{inquiry.name}</a>
                                </td>
                                <template for:each={inquiry.displayFields} for:item="field">
                                    <td key={field.key} class="slds-truncate">
                                        <template if:true={field.hasValue}>
                                            <template if:true={field.isNameField}>
                                                <a href="javascript:void(0)" data-id={inquiry.id}
                                                    onclick={navigateToRecord}>{field.value}</a>
                                            </template>
                                            <template if:false={field.isNameField}>
                                                <template if:true={field.isCurrency}>
                                                    {inquiry.CurrencyIsoCode} {field.value}
                                                </template>
                                                <template if:false={field.isCurrency}>
                                                    {field.value}
                                                </template>
                                            </template>
                                        </template>
                                        <template if:false={field.hasValue}>
                                            <template if:true={field.isCurrency}>
                                                TBD
                                            </template>
                                        </template>
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </template>
            <template if:false={pagedInquries.length}>
                <div class="no-prop">
                    <img src={NoDataImageUrl} class="no-data-img" alt="No Data Found">
                    <p>No Inquiry found. Please change your search filters and try again.</p>
                </div>
            </template>
        </div>

        <template if:true={pagedInquries.length}>
            <div class="pagination-container">
                <button class="pagination-button" disabled={isFirstPage} onclick={handlePrevious}>
                    <svg xmlns="http://www.w3.org/2000/svg" height="52" width="52" viewBox="0 0 520 520" fill="#fff">
                        <path
                            d="M342 477 134 272c-6-6-6-16 0-22L342 45c6-6 16-6 22 0l22 22c6 6 6 16 0 22L221 250c-6 6-6 16 0 22l163 161c6 6 6 16 0 22l-22 22c-5 5-14 5-20 0z" />
                    </svg>
                    Previous
                </button>

                <template for:each={pageNumbers} for:item="page">
                    <template if:false={page.isEllipsis}>
                        <button key={page.number} data-id={page.number} class={page.className}
                            onclick={handlePageChange}>
                            {page.number}
                        </button>
                    </template>
                    <template if:true={page.isEllipsis}>
                        <span key={page.number} class="pagination-ellipsis">...</span>
                    </template>
                </template>

                <button class="pagination-button" disabled={isLastPage} onclick={handleNext}>
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" height="52" width="52" viewBox="0 0 520 520" fill="#fff">
                        <path
                            d="m179 44 207 205c6 6 6 16 0 22L179 476c-6 6-16 6-22 0l-22-22c-6-6-6-16 0-22l163-161c6-6 6-16 0-22L136 88c-6-6-6-16 0-22l22-22c6-5 15-5 21 0z" />
                    </svg>
                </button>
            </div>
        </template>
    </div>

    <template if:true={isMassEmailModalOpen}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true"
            aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open slds-modal_small">
            <div class="slds-modal__container">
                <!-- Modal/Popup Header -->
                <div class="slds-modal__close closs_icon_css" onclick={closeModal}>
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M2.53317 19.3333L0.666504 17.4667L8.13317 9.99999L0.666504 2.53332L2.53317 0.666656L9.99984 8.13332L17.4665 0.666656L19.3332 2.53332L11.8665 9.99999L19.3332 17.4667L17.4665 19.3333L9.99984 11.8667L2.53317 19.3333Z"
                            fill="white" />
                    </svg>
                </div>

                <div class="slds-modal__header blue-header">
                    <h1 class="slds-modal__title slds-hyphenate" tabindex="-1">Send Email</h1>
                </div>

                <!-- Modal/Popup Body -->
                <div class="slds-modal__content slds-p-around_medium custom-modal-content">
                    <template if:true={isFirstScreen}>
                        <div class="total-records">
                            Total Inquiry Selected : {totalSelectedItems}
                        </div>

                        <div class="dotted-border"></div>

                        <div class="input-box">
                            <legend class="slds-form-element__legend slds-form-element__label"><span
                                    class="red">*</span>How do you want to send?</legend>
                            <lightning-combobox name="sendMethod" value={sendMethod} placeholder="Select a method"
                                options={messageOptions} onchange={handleSendMethodChange}>
                            </lightning-combobox>
                        </div>

                        <div class="input-box">
                            <legend class="slds-form-element__legend slds-form-element__label"><span
                                    class="red">*</span>Select Custom Template</legend>
                            <lightning-combobox name="gmailTemplate" value={selectedTemplate}
                                placeholder="Select a template" options={quickTemplates}
                                onchange={handletemplateChange}>
                            </lightning-combobox>
                        </div>


                        <div class="input-box" if:true={isForSingle}>
                            <legend class="slds-form-element__legend slds-form-element__label">Select Listing Template
                            </legend>
                            <lightning-combobox name="listingTemplate" value={selectedListingTemplate}
                                placeholder="Select a template" options={listingTemplateOptions}
                                onchange={handleListingTemplateChange}>
                            </lightning-combobox>
                        </div>
                    </template>

                    <template if:false={isFirstScreen}>
                        <div class="content-body">
                            <template if:true={isTemplateBody}>
                                <div class="template-body-header">
                                    <h3>Preview</h3>
                                </div>
                                <div class="dotted-border"></div>
                                <div class="scrollable-content">
                                    <div class="richText"></div>
                                </div>
                            </template>
                        </div>
                        <iframe lwc:if={vfGeneratePageSRC} class="generate_iframe" src={vfGeneratePageSRC} width="0%"
                            height="0%"></iframe>
                    </template>

                    <div class="footer-btns">
                        <template if:true={isFirstScreen}>
                            <button class="save_btn_css" onclick={handleFooterButtonClick}>Next</button>
                        </template>
                        <template if:false={isFirstScreen}>
                            <button class="cancel_btn_css" onclick={handleBack}>Back</button>
                            <button class="save_btn_css" onclick={handleFooterButtonClick}>Send</button>
                        </template>
                    </div>
                </div>

            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>

    </template>


    <template if:true={showTemplate}>
        <section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="modal-heading-01"
            class="slds-modal slds-fade-in-open slds-modal_small">
            <div class="slds-modal__container send-template-modal-container">
                <div class="slds-modal__close closs_icon_css" onclick={handleCloseTemplate}>
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M2.53317 19.3333L0.666504 17.4667L8.13317 9.99999L0.666504 2.53332L2.53317 0.666656L9.99984 8.13332L17.4665 0.666656L19.3332 2.53332L11.8665 9.99999L19.3332 17.4667L17.4665 19.3333L9.99984 11.8667L2.53317 19.3333Z"
                            fill="white" />
                    </svg>
                </div>

                <div class="slds-modal__header blue-header">
                    <h1 class="slds-modal__title slds-hyphenate" tabindex="-1">{popupHeader}</h1>
                </div>

                <div class="modal-body">
                    <div class="custom-modal-body" id="modal-content-id-1">
                        <template if:true={popUpSecondPage}>
                            <div class="secondPage">
                                <!-- Group 1: Template Selection & Preview (Left) -->
                                <div class="template-selector-section">
                                    <div class="template-selector-wrapper">
                                        <lightning-combobox name="template" label="Select Template"
                                            options={templateOptions} onchange={handleInputChange}
                                            value={selectedTemplate} required
                                            message-when-value-missing="Template is required"
                                            class="template-combobox">
                                        </lightning-combobox>
                                    </div>

                                    <div class="template-prev">
                                        <div class="preview-box-container">
                                            <template if:true={selectedTemplate}>
                                                <div class="preview-box">
                                                    <c-template-preview template-id={selectedTemplate}
                                                        record-id={previewRecordId} object-api-name={selectedObject}>
                                                    </c-template-preview>
                                                </div>
                                            </template>
                                            <template if:false={selectedTemplate}>
                                                <div class="preview-placeholder">
                                                    Please select a template to preview.
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- Group 2: Contact List (Right) -->
                                <div class="preview-section-right">
                                    <lightning-input type="search" variant="label-hidden"
                                        placeholder="Search by Name or Phone..."
                                        onchange={handleSearchMembers} class="contact-search">
                                    </lightning-input>

                                    <div class="selected-contacts-section">
                                        <div class="contacts-table-wrapper">
                                            <table class="contacts-table">
                                                <thead>
                                                    <tr>
                                                        <th>Name</th>
                                                        <th>Phone</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <template if:true={filteredGroupMembers.length}>
                                                        <template for:each={filteredGroupMembers} for:item="member">
                                                            <tr key={member.Id}>
                                                                <td>{member.Name}</td>
                                                                <td>{member.Phone}</td>
                                                                <td>
                                                                    <lightning-button-icon 
                                                                        icon-name="utility:delete" 
                                                                        variant="bare" 
                                                                        alternative-text="Remove" 
                                                                        title="Remove" 
                                                                        data-id={member.Id}
                                                                        onclick={handleRemoveMember}>
                                                                    </lightning-button-icon>
                                                                </td>
                                                            </tr>
                                                        </template>
                                                    </template>
                                                    <template if:false={filteredGroupMembers.length}>
                                                        <tr>
                                                            <td colspan="3" class="no-results-cell">
                                                                <div class="no-results-container">
                                                                    <lightning-icon icon-name="utility:search" size="small"></lightning-icon>
                                                                    <span>No matching contacts found</span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                             <div class="popUpFooter slds-text-align--center">
                                <lightning-button variant="brand" label="Send" onclick={handleConfirmPopup}
                                    class="slds-m-left_x-small"></lightning-button>
                                <lightning-button variant="brand" label="Schedule" onclick={handleSchedulePopup}
                                    class="slds-m-left_x-small"></lightning-button>
                            </div>
                        </template>

                    </div>
                </div>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open main-modal-backdrop"></div>


        <!-- Last Page: Selection of Date and Time (Now as Overlay Modal) -->
        <template if:true={popUpLastPage}>
            <div class="slds-backdrop slds-backdrop_open schedule-modal-backdrop"></div>
            
            <section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="datetime-modal-heading"
                class="slds-modal slds-fade-in-open schedule-modal">
                <div class="slds-modal__container schedule-modal-container">
                    <div class="slds-modal__close schedule-close-icon" onclick={handlePreviousLastPage}>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M2.53317 19.3333L0.666504 17.4667L8.13317 9.99999L0.666504 2.53332L2.53317 0.666656L9.99984 8.13332L17.4665 0.666656L19.3332 2.53332L11.8665 9.99999L19.3332 17.4667L17.4665 19.3333L9.99984 11.8667L2.53317 19.3333Z"
                                fill="white" />
                        </svg>
                    </div>

                    <div class="slds-modal__header schedule-modal-header">
                        <h2 class="slds-modal__title" id="datetime-modal-heading">Schedule Date & Time</h2>
                    </div>

                    <div class="slds-modal__content schedule-modal-content">
                        <div class="datetime-selection-wrapper">
                            <div class="timezone-note">
                                <svg class="w-6 h-6 text-gray-800 cal-icon" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 10h16M8 14h8m-4-7V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Z"/>
                                </svg>
                                <div class="schedule-message">
                                    <p class="main-line">Schedule your message</p>
                                    <p class="next-line">Choose when to send the template.</p>
                                </div>
                            </div>
                            <lightning-input type="datetime-local" name="dateTime" label="Select Date and Time"
                                value={selectedDateTime} onchange={handleInputChange} required
                                message-when-value-missing="Please select a date and time"
                                variant="label-stacked">
                            </lightning-input>
                        </div>

                        <div class="schedule-modal-footer slds-text-align--center">
                            <lightning-button variant="neutral" label="Cancel" onclick={handlePreviousLastPage}></lightning-button>
                            <lightning-button variant="brand" label="Confirm & Send" onclick={handleSchedule}></lightning-button>
                        </div>
                    </div>
                </div>
            </section>
        </template>

        <div class="slds-backdrop slds-backdrop_open main-modal-backdrop"></div>

        <template if:true={popUpConfirmPage}>
            <div class="slds-backdrop slds-backdrop_open schedule-modal-backdrop" onclick={handleBackdropClick}></div>
            
            <section role="dialog" tabindex="-1" aria-modal="true" aria-labelledby="confirm-modal-heading"
                class="slds-modal slds-fade-in-open confirm-modal"
                aria-describedby="modal-content-id-3">
                <div class="slds-modal__container schedule-modal-container">
                    <div class="slds-modal__close schedule-close-icon" onclick={handlePreviousLastPage}>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M2.53317 19.3333L0.666504 17.4667L8.13317 9.99999L0.666504 2.53332L2.53317 0.666656L9.99984 8.13332L17.4665 0.666656L19.3332 2.53332L11.8665 9.99999L19.3332 17.4667L17.4665 19.3333L9.99984 11.8667L2.53317 19.3333Z"
                                fill="white" />
                        </svg>
                    </div>

                    <div class="slds-modal__header schedule-modal-header">
                        <h2 class="slds-modal__title" id="confirm-modal-heading">Are you sure?</h2>
                    </div>

                    <div class="slds-modal__content schedule-modal-content" id="modal-content-id-3">
                        <p>Are you sure you want to send this template to the selected contacts?</p>
                        

                        <div class="schedule-modal-footer slds-text-align--center">
                                    <lightning-button variant="neutral" 
                            label="Cancel" 
                            onclick={handlePreviousLastPage}>
                        </lightning-button>
                        <lightning-button variant="brand" 
                            label="Confirm & Send" 
                            onclick={handleSendOnPopup}>
                        </lightning-button>
                                </div>
                    </div>

                </div>
            </section>
        </template>
    </template>
</template>