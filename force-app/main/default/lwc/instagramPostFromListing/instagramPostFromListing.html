<template>
    <!-- Lightning Spinner for initial loading and upload -->
    <template if:true={isLoading}>
        <div class="loading-spinner">
        <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
        </div>
    </template>

    <!-- Custom Progress Spinner for upload -->
    <template if:true={showSpinner}>
        <div class="overlay-spinner">
            <div class="upload-wrapper-spinner">
                <img src="/resource/MVEX__Animationimg" alt="Loading..." draggable="false">

                <div class="progress-section">
                    <div class="progress-bar">
                        <div class="progress-fill" style={progressStyle}></div>
                    </div>
                    <div class="progress-text saturationAnimation">{progressText}</div>
                </div>
            </div>
        </div>
    </template>

    <div class="wrapper-instagram-post">

        <div class="slds-modal__header blue-header">
            <h1 id="modal-heading-01" class="slds-modal__title slds-hyphenate" tabindex="-1">Instagram Post Uploader</h1>
        </div>

        <div class="content-body">
            <template if:false={hasAllCredentials}>
                <div class="credentials-missing-container">
                    <div class="credentials-missing-content">
                        <img src="/resource/MVEX__emptyState" alt="Credentials Required" class="credentials-empty-icon" draggable="false"/>
                        <div class="credentials-missing-message">
                            {missingCredentialsMessage}
                        </div>
                        <div class="credentials-missing-submessage">
                            Please configure your credentials in the integration settings.
                        </div>
                    </div>
                </div>
            </template>

            <template if:true={hasAllCredentials}>
                <!-- EMPTY STATE: No files selected -->
                <template if:false={isFileAvailable}>
                    <div class="instagram-post-body-empty">
                        <div class="fileuploader_container">
                            <div class="slds-file-selector slds-file-selector_images" ondrop={handleDrop}
                                ondragover={allowDrop}>
                                <div class="slds-file-selector__dropzone flex_css">
                                    <div>
                                        <svg width="36" height="28" viewBox="0 0 36 28" fill="none"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M3.232 28C2.31067 28 1.542 27.692 0.926 27.076C0.31 26.46 0.00133333 25.6907 0 24.768V3.232C0 2.31067 0.308667 1.542 0.926 0.926C1.54333 0.31 2.31133 0.00133333 3.23 0H11.85C12.2807 0 12.6993 0.0866669 13.106 0.26C13.5127 0.436 13.8607 0.668667 14.15 0.958L17.192 4H32.77C33.69 4 34.4587 4.30867 35.076 4.926C35.6933 5.54333 36.0013 6.312 36 7.232V24.77C36 25.69 35.692 26.4587 35.076 27.076C34.46 27.6933 33.6913 28.0013 32.77 28H3.232ZM18 22.46C18.2853 22.46 18.5233 22.3653 18.714 22.176C18.9047 21.9867 19 21.7487 19 21.462V13.062L22.532 16.592C22.7187 16.7787 22.9473 16.8787 23.218 16.892C23.4887 16.9053 23.7313 16.8053 23.946 16.592C24.1607 16.3787 24.2673 16.1427 24.266 15.884C24.2647 15.6253 24.158 15.39 23.946 15.178L19.13 10.362C18.8073 10.0393 18.4307 9.878 18 9.878C17.5693 9.878 17.192 10.0393 16.868 10.362L12.132 15.1C11.944 15.2867 11.844 15.516 11.832 15.788C11.82 16.06 11.92 16.3027 12.132 16.516C12.344 16.7293 12.5793 16.836 12.838 16.836C13.0967 16.836 13.3327 16.7293 13.546 16.516L17 13.06V21.46C17 21.744 17.0953 21.982 17.286 22.174C17.4767 22.366 17.7147 22.4613 18 22.46Z"
                                                fill="#0276D3" />
                                        </svg>
                                    </div>
                                    <div class="formbold-drop-file images_upcss">
                                        <p>Choose files or drag & drop here</p>
                                        <p class="support-text">Supports: JPG, PNG, WEBP, MP4, MOV</p>
                                        <input type="file" class="slds-file-selector__input slds-assistive-text"
                                            onchange={handleSelectedFiles}
                                            accept="image/jpeg,image/png,image/webp,video/mp4,video/quicktime"
                                            id="file-upload-input-107" multiple
                                            aria-labelledby="file-selector-primary-label-105 file-selector-secondary-label106" />
                                        <label class="slds-file-selector__body" for="file-upload-input-107"
                                            id="file-selector-secondary-label106">
                                            <span class="formbold-browse">Browse Files</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- SELECTED STATE: Files selected -->
                <template if:true={isFileAvailable}>
                    <div class="instagram-post-body-selected">
                        <div class="selected-images-header">
                            <h3>Selected Images ({selectedFileWithPreview.length})</h3>
                        </div>

                        <div class="image-preview-container-wrapper-selected" ondrop={handleDropImages} ondragover={handleDragOver}>
                            <div class="image-preview-container-selected">
                                <template for:each={selectedFileWithPreview} for:item="file" for:index="index">
                                    <div key={file.name} class="image-preview-item-selected dropableimage" data-index={index}
                                        draggable="true" ondragstart={handleDragStart} ondragenter={handleDragEnter}
                                        ondragleave={handleDragLeave} ondragend={handleDragEnd}>
                                        <img src={file.preview} alt={file.name} class="image-preview-selected"
                                            draggable="true" data-index={index} />
                                        <div class="overlay-selected">
                                            <div class="cancel-button-selected" data-name={file.name}
                                                onclick={handleRemoveFile}><lightning-icon icon-name='utility:close' alternative-text='close' class="close-icon" size='x-small' title='close'></lightning-icon></div>
                                        </div>
                                    </div>
                                </template>
                                <div class="add-more-tile">
                                    <input type="file" class="slds-file-selector__input slds-assistive-text"
                                        onchange={handleSelectedFiles}
                                        accept="image/jpeg,image/png,image/webp,video/mp4,video/quicktime"
                                        id="file-upload-input-add" multiple
                                        aria-labelledby="file-selector-add-label" />
                                    <label class="add-more-label" for="file-upload-input-add" id="file-selector-add-label">
                                        <lightning-icon icon-name='utility:add' class="add-icon" alternative-text='add' size='small' title='add'></lightning-icon>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="caption-input-selected">
                    <div class="caption-label-wrapper">
                        <label for="caption"><lightning-icon icon-name='utility:edit' class="custom-icon-edit" alternative-text='edit' size='x-small' title='edit'></lightning-icon>Caption</label>
                    </div>
                    <textarea data-id="caption" placeholder="Write your caption here... Share your story!" maxlength="2200" class="caption-textarea"
                        value={caption} onchange={handleCaptionChange}></textarea>
                </div>

                <div class={submitContainerClass}>
                    <button
                        onclick={handlePost}
                        class={uploadButtonClass}
                        disabled={isUploadDisabled}
                    >
                        <lightning-icon
                            icon-name="utility:upload"
                            class="custom-upload-icon"
                            alternative-text="upload"
                            size="x-small"
                            title="upload">
                        </lightning-icon>
                        Upload Post
                    </button>

                    <template if:false={isFileAvailable}>
                        <p class="error-message">⊘ Please select an image or video to continue</p>
                    </template>


                    <template if:false={isUploadDisabled}>
                         <p class="error-message">ℹ️ Listing image that were uploaded via AWS are supported.</p>
                    </template>
                </div>

            </template>
        </div>
    </div>
</template>



