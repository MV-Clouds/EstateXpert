<apex:page controller="FBLoginController">
    <script crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js" async="true" defer="true"></script>
    <script>

        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId');
        const clientSecret = urlParams.get('clientSecret');
        const configId = urlParams.get('configId');
        const phoneId = urlParams.get('phoneId');
        const accountId = urlParams.get('accountId');
        // Initialize the Facebook SDK
        window.fbAsyncInit = function() {
            FB.init({
                //appId      : '501746772599385', 
                appId      : clientId, 
                cookie     : true,          
                xfbml      : true,           
                version    : 'v21.0'        
            });

            // Check the current login status
            FB.getLoginStatus(function(response) {
                statusChangeCallback(response);
            });
        };
        

        function statusChangeCallback(response) {
            if (response.status === 'connected') {
                console.log('Logged in.');
                console.log('response ==> ' , response);
                var sAccessToken = response.authResponse.accessToken
                var userId = response.authResponse.userID
                Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.FBLoginController.saveFBLoginDetails}',
                sAccessToken, userId, clientId, clientSecret, configId,phoneId,accountId,
                function(result, event){
                    if(event.status){
                        console.log("Apex result ==> ", result);
                    }else {
                        console.error('Apex error:', event.message);
                    }
                },
                {escape: true}
            	);
                
                FB.api('/me?fields=name,picture', function(response) {
                    document.getElementById('userInfo').innerHTML = `
                    <div style="width: 100%;height: 95vh;align-items: center;justify-content: center;display: flex;flex-direction: column;">
                        <div style="display: flex;flex-direction: column;align-items: center;gap: 1rem; padding: 2rem;border: solid 1px #0176d9;border-radius: 8px;">
                        <h3>Welcome, ${response.name}</h3>
                        <img src="${response.picture.data.url}" alt="Profile Picture">
                        <div style="diplay:flex;gap:1rem">
                        <button style="padding: 8px 16px; color: white; background: #0176d9; border: none; cursor: pointer;" onclick="facebookLogout()">Logout</button>
                         <button style="padding: 8px 16px; color: #0176d9; background: white; border: solid 1px; cursor: pointer;" onclick="handleCancel()">Cancel</button></div>
                        </div>
                    </div>
                    `;
                });
            } else {
                console.log('Not authenticated.');
                document.getElementById('userInfo').innerHTML = `
                <div style="width: 100%;height: 95vh;align-items: center;justify-content: center;display: flex;flex-direction: column;">
                    <div style="display: flex;flex-direction: column;align-items: center;gap: 1rem; padding: 2rem;border: solid 1px #0176d9;border-radius: 8px;">
                    <h3>Welcome, Please login into facebook</h3>
                    <div style="diplay:flex;gap:1rem">
                    <button style="padding: 8px 16px; color: white; background: #0176d9; border: none; cursor: pointer;" onclick="facebookLogin()">Login with Facebook</button>
                    <button style="padding: 8px 16px; color: #0176d9; background: white; border: solid 1px; cursor: pointer;" onclick="handleCancel()">Cancel</button></div>
                    </div>
                </div>
                `;
            }
        }
    
        function facebookLogin() {
            FB.login(function(response) {
                if (response.authResponse) {
                    console.log('Welcome! Fetching your information....');
                    const accessToken = response.authResponse.accessToken;
                    console.log('accessToken ==> ' , accessToken);
                    FB.api('/me', function(response) {

                        console.log('response ==> ' , response);
                        console.log('Good to see you, ' + response.name + '.');
                        // document.getElementById('userInfo').innerHTML = `
                        // <div style="width: 100%;height: 95vh;align-items: center;justify-content: center;display: flex;flex-direction: column;">
                        // <div style="display: flex;flex-direction: column;align-items: center;gap: 1rem; padding: 2rem;border: solid 1px #0176d9;border-radius: 8px;">
                        //     <h3>Welcome, ${response.name}</h3>
                        //     <img src="https://graph.facebook.com/${response.id}/picture?type=large" alt="Profile Picture">
                        //     <button style="padding: 8px 16px; color: white; background: #0176d9; border: none; cursor: pointer;" onclick="facebookLogout()">Logout</button>
                        //     </div>
                        // </div>
                        // `;
                        const baseUrl = window?.globalThis?.location?.origin + '/one/one.app#';
                        let componentDef = {
                            componentDef: "c:socialMediaIntegration",
                            attributes: {
                                c__status: 'success'
                            }
                        };
                        let encodedComponentDef = btoa(JSON.stringify(componentDef));
    
                        const redirectUrl = `${baseUrl}${encodedComponentDef}`;
                        window?.globalThis?.location?.href = redirectUrl;
                    });

                } else {
                    console.log('User cancelled login or did not fully authorize.');
                }
            }, {
               config_id: configId });
        }

        function facebookLogout() {
            FB.logout(function(response) {
                console.log('Logged out.');
                document.getElementById('userInfo').innerHTML = `
                  <div style="width: 100%;height: 95vh;align-items: center;justify-content: center;display: flex;flex-direction: column;">
                    <div style="display: flex;flex-direction: column;align-items: center;gap: 1rem; padding: 2rem;border: solid 1px #0176d9;border-radius: 8px;">
                    <h3>Welcome, Please login into facebook</h3>
                    <div style="diplay:flex;gap:1rem">
                        <button style="padding: 8px 16px; color: white; background: #0176d9; border: none; cursor: pointer;" onclick="facebookLogin()">Login with Facebook</button>
                        <button style="padding: 8px 16px; color: #0176d9; background: white; border:  solid 1px; cursor: pointer;" onclick="handleCancel()">Cancel</button>
                        </div>
                    </div>
                </div>
                `;
            });
        }

        function handleCancel() {
            const baseUrl = window.location.origin + '/one/one.app#';
            let componentDef = {
                componentDef: "c:socialMediaIntegration"
            };
            let encodedComponentDef = btoa(JSON.stringify(componentDef));

            const redirectUrl = `${baseUrl}${encodedComponentDef}`;
            window.location.href = redirectUrl;
        }
    </script>

    <!-- <h2>Facebook Login</h2> -->
    <div id="userInfo">
        <!-- This will be filled dynamically based on login status -->
        

    </div>
</apex:page>